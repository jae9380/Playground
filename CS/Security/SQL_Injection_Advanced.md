# SQL-Injection (advanced)

이번에는 `SQL Injection`공격에 대하요 심화 개념을 알아보고 실제 공격에 사용되는 기법에 대해서 확인 할 것이다.   

## 간단한 연습 문제   

![](https://i.postimg.cc/NFy1y3tR/Q3.png)
해당 항목의 문제는 주어진 3개의 테이블에 존재하는 모든 데이터를 조회를 한 다음 이를 바탕으로 Dave의 비밀번호를 알아내면 된다. 2개의 테이블에 대한 `Create`쿼리를 제공하고 있기에 테이블의 구조를 파악할 수 있다는 점을 참고하면 된다.   


![](https://i.postimg.cc/SNh6Qt5Y/Q3-A1.png)   
일단 임의의 값을 넣었을 때 생성되는 쿼리문을 살펴보면 `user_data`테이블에서 데이터를 조회하고 있다.    

문제에서 제공한 생성 쿼리문을 보면 유저의 비밀번호는 `user_data`테이블이 아닌 `user_system_data`테이블에 비밀번호를 관리하고 있다는 것을 확인 가능하다.   

이 문제는 사실 `SQL Injection` 기본 개념을 확인할 때 배운 `SQL Query chaining`을 이용하여 쉽게 해결 가능하다. 

```sql
hi'; SELECT * FROM user_system_data--
```
이 처럼 싱글쿼터를 이용하여 문자열 범위를 벗어나고 세미콜론을 이용하여 쿼리문 범위를 지정한다. 다음으로 `SELECT`쿼리를 작성하고 마지막 부분에는 주석을 이용하여 문법적인 오류 방지를 해주면 아래와 같이 쉽게 공략이 가능해진다.   
![](https://i.postimg.cc/QxzjkR3H/Q3-A2.png)

또 다른 방법으로 공격을 할 생각이다.   

다른 나머지 방법으로는 `union`연산자를 이용하는 방법이다. `union`은 쿼리를 실행한 뒤 그 결과를 합하는 기능이다. 그래서 해당 연산자를 이용하여 우리가 원하는 정보를 갖고있는 테이블의 데이터를 조회할 수 있다.    

해당 연산자에서 가장 중요한 부분은 합치고자 하는 결과들 각각의 칼럼 수와 합쳐지는 컬럼끼리의 타입이 동일해야 한다는 점이다.    

일단 정답을 먼저 확인을 하면   
```sql
hi' UNION SELECTT userid, user_name, password, null, nlull, cookie, null FROM user_system_data--
```

해당 공격 구문을 확인을 하면, 임의의 값을 입력을 하여 앞 조건은 거짓으로 만들고 싱글쿼터와 세미클론을 이용하고 `union`연산을 이용하여 뒤에 오는 `SELECT`문을 실행한다.    

이렇게 구성을 하게되면 앞 조건은 거짓이기에 합할 데이터가 없어져서 뒤에 올 `SELECT`쿼리의 결과만 노출하는 방법을 이용 했다.   

그리고 초회를 할 컬럼의 수가 앞의 `SELECT`쿼리와 동일해야 하는데 실행된 쿼리를 확인하면 `user_data`의 7개 컬럼에 대하여 모든 데이터를 조합 했을 때 컬럼의 수가 차이가 존재한다. 그렇기 때문에 Null을 이용하여 데이터 타입과는 관계없이 대응이 가능하다.   


## Blind SQL Injection

지금까지 확인한 방법으로 공격을 성공하기는 힘들다. 예제에서는 오류 내용이나 쿼리 실행 결과 전체를 알려주었기 때문에 쉽게 수정할 수 있었는데 시제 대부분의 웹 서비스들은 쿼리 실행문 결과 전체를 노출하는 경우는 극히 드물기 때문이다. 또한 에러 헨들링을 잘 해두어 오류 내용이 나타나는 경우 역시 찾기 힘들다.    

그러면 어떠한 방법으로 공격을 하는 것일까?   

쿼리의 실행문을 직접 확인할 방법은 없지만 서버의 응답을 통하여 쿼리의 참과 거짓을 구분할 수 있다면 데이터를 잘게 나누어 특정한 값과 비교하는 `SQL Injection`을 수행할 수 있는 행위를 `Blind SQL Injection`이라고 한다.   

해당 공격에는 여러가지 방법이 있다. 대표적으로 오류를 참고하여 참과 거짓을 구분하는 `Error based Blind SQL Injection`과 쿼리 실행에 소요되는 시간 차를 기준으로 구분하는 `Time based Blind SQL Injection` 그리고 서버의 응답 본문을 기준으로 구분하는 `Content based Blind SQL Injection` 등의 방법이 있다.    


