# CompletableFuture : 안정적 비동기 프로그래밍     

자바8, 9dptjsms `CompletableFuture`와 리액티브 프로그래밍 패러다임 두 API를 제공을 한다. 그래서 실용적인 예제를 바탕으로 자바8에서 제공하는 `Future`의 `CompletableFuture`이 비동기 프로그램에 어떤 영향을 끼치는지, 자바9에 추가된 내용을 확인을 할 것이다.   

## Future의 단순 활용   

자바5 부터 미래 어느 한 시점에 결과를 얻는 모델에 활용할 수 있도록 해당 인터페이스를 제공한다. `Future`는 계산이 끝났을 때 결과에 접근할 수 있는 참조를 제공을 한다. 그래서 시간이 걸릴 수 있는 작업을 `Future`내부로 설정을 한다면, 호출자 쓰레드가 결과를 기달리는 동안 다른 유용한 작업을 수행할 수 있게 만든다.   

일상 생활에서의 비유를 한다면 세탁소에서 한 무더기의 옷을 맡긴다고 할 때, 언제 다시 방문을 하면 찾아갈 수 있는지 알려주면 우리는 작업이 끝나는 동안 다른 일들을 처리할 수 있는 것 처럼    

`Future`는 저수준의 쓰레드에 비하여 직관적으로 이해하기 쉽다는 장점이 있다. `Future`를 이용하려면 시간이 오래 소요되는 작업을 `Callable`객체 내부로 감싸고 `ExecutorService`에 제출해야 한다.   


* 자바8 이전의 예제 코드
```java
ExecutorService es = Executors.newCachedThreadPool();   
Future<Double> future = es.submit(new Callable<Double>() {
    public Double call() {
        return doSomeLongComputation();
    }
});

doSomeLongComputation();
try {
    Double result = future.get(1, TimeUnit.SECONDS);
}catch (ExecutionException ee) {
    ...
}catch(...) {

}
```

위 예제 코드처럼 프로그래밍에서는 `ExecutorService`에서 제공하는 쓰레드가 시간이 오래 소모되는 작업을 처리하는 동안 우리 쓰레드로 다른 작업을 동시에 실행할 수 있다. 다른 작업을 수행하다가 시간이 오래 걸리는 작업의 결과 값이 필요한 시점에서는 `Future`에서 `get`메소드로 값을 갖고올 수 있다.

여기서 `get`메소드를 이용하여 값을 갖고 올 때, 만약 해당하는 값이 준비되지 않았을 때 해당 작업이 완료될 때까지 쓰레드를 블록시고, 준비가 완료되었을 때는 해당 값을 반환을 해준다.   

그런데 해당 값을 갖고올려고 하는데 계산 중 문제가 발생한다면 필요한 값을 영원히 기달리게 되는 문제점이 발생하게 된다.   

## Future 제한    

비동기 계산이 완료돠었는지 확인하는 메소드, 계산이 끝나기를 기달리는 메소드, 결과를 회수하는 메소드 등의 메소드만으로 간결한 동시 실행 프로그램을 구현하기에 부족하다. 예를 들어 여러`Future`의 결과가 있을 때 이들의 의존성은 표현하기가 어렵다. 다시 말해서 '오래 걸리는 A라는 작업이 끝나면 그 결과 값으로 오래 걸리는 다른 작업 B로 전달하고, 그리고 B작업의 결과가 나오면 다른 질의의 결과와 B의 결과를 조합을 해라'와 같은 상황에서 쉽게 구현을 할 수 있어야 한다. 하지만 `Future`로 이와 같은 동작을 구현하는 것은 단순하지 않다.   

다음과 같은 선언형 기능이 있다면 유용할 것이다.   
 * 두 개의 비동기 계산 결과를 하나로 합친다. 두 가지 계산 결과는 서로 독립적일 수 있으며 또는 두 번째 결과가 첫 번쨰 결과에 의존하는 상황일 수 있다.   
 * Future집합이 실행하는 모든 테스크의 완료를 기달린다.
 * Future 집합에서 가장 빨리 완료되는 테스크를 기달렸다가 결과를 얻는다.   
 (예를 들어서 테스크가 다양한 방식으로 같은 결과를 구하는 상황)
 * 프로그램으로 Future를 완료시킨다.   
 (즉, 비동기 동작에 수동으로 결과 제공)   
 * Future 완료 동작에 반응한다.    
 (즉, 결과를 기달리면서 블록되지 않고 결과가 준비되었다는 알림을 받은 다음 Future의 결과로 원하는 추가 동작을 수행할 수 있다.)   

지금까지 설명한 선언형으로 이용할 수 있도록 자바8에서 새로 제공하는 `CompletableFuture`클래스를 살펴본다.    

## CompletableFuture로 비동기 어플리케이션 제작   

어떠한 서비스를 만든다고 가정을 하고 다음과 같은 기술을 확인을 할 것이다.    
* 바동기 API를 제공하는 방법
* 동기 API를 사용을 해야 할 때 코드를 바블록으로 작성하는 방법   
  두 개의 비동기 동작을 파이프라인으로 만드는 방법과 두 개의 동작 결과를 하나의 비동기 계산으로 합치는 방법   
* 비동기 동작의 완료에 대응하는 방법   
  어떠한 정보를 얻을 때까지 기달리는 것이 아닌 각 정보를 얻을 때마다 동작하는 방법   

### 비동기 API구현    

최저가 검색을 하는 어플리케이션을 구현을 한다고 가정을 하자. 해당 어플리케이션은 각 상점에서 제공하는 API부터 정의하자. 
```java
public class Shop {
    public double getPrice(String product) {
        // 구현 부
    }
}
```

`getPrice`메소드는 상점의 데이터베이스를 이용하여 가격 정보를 얻는 동시에 다른 외부 서비스에도 접급할 것이다.